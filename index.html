<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Installer Portal</title>

  <style>
    :root {
      --primary: #1a365d;
      --bg: #f7fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1a202c;
      --muted: #718096;
      --radius: 12px;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 40px 16px;
    }

    .app {
      width: 100%;
      max-width: 900px;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 16px;
      color: var(--primary);
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      border: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    input {
      flex: 1;
      min-width: 160px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 15px;
      outline: none;
    }

    button {
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }

    button.secondary {
      background: #e2e8f0;
      color: #1a202c;
    }

    .hint {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .status {
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--muted);
    }

    .error {
      color: #b00020;
      font-weight: 700;
    }

    .section-title {
      margin-top: 12px;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
    }

    pre {
      background: #0f172a;
      color: #e5e7eb;
      padding: 14px;
      border-radius: 12px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.4;
      border: 1px solid #1e293b;
      margin: 0;
    }

    .pdf-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 8px;
      background: #fff;
    }

    .pdf-name {
      font-weight: 600;
    }

    .pdf-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
  </style>
</head>

<body>
<div class="app">
  <h1>üõ†Ô∏è Installer Portal</h1>

  <!-- LOGIN -->
  <div class="card">
    <div class="section-title">Login</div>
    <div class="row">
      <input id="u" placeholder="username (e.g. igorbens)" />
      <input id="p" type="password" placeholder="password" />
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" class="secondary" style="display:none;">Logout</button>
    </div>
    <div class="hint" id="loginStatus">Not logged in.</div>
  </div>

  <!-- TASK LOOKUP -->
  <div class="card">
    <div class="row">
      <input id="taskId" type="number" placeholder="Task ID (e.g. 3369)" />
      <button id="btn">Fetch task</button>
    </div>

    <div class="hint">
      Calls secured n8n webhook
    </div>

    <div class="output">
      <div id="status" class="status">Waiting for input‚Ä¶</div>

      <div class="section-title">PDFs</div>
      <div id="pdfs" class="hint">‚Äî</div>

      <div class="section-title">Raw JSON</div>
      <pre id="out">‚Äî</pre>
    </div>
  </div>
</div>

<script>
  // üîß CHANGE THIS TO YOUR TASK WEBHOOK BASE
  const WEBHOOK_BASE = "https://thermoduct.app.n8n.cloud/webhook/c3f563b3-c04f-4b01-820d-11173ba9bd31/thermoduct";

  const AUTH_WEBHOOK = "https://thermoduct.app.n8n.cloud/webhook/auth/login";

  const out = document.getElementById("out");
  const statusEl = document.getElementById("status");
  const taskIdInput = document.getElementById("taskId");
  const btn = document.getElementById("btn");
  const pdfsEl = document.getElementById("pdfs");

  const uEl = document.getElementById("u");
  const pEl = document.getElementById("p");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginStatus = document.getElementById("loginStatus");

  // ===== AUTH STORAGE =====
  function setCreds(u, p) {
    sessionStorage.setItem("u", u);
    sessionStorage.setItem("p", p);
  }
  function getCreds() {
    return {
      u: sessionStorage.getItem("u") || "",
      p: sessionStorage.getItem("p") || "",
    };
  }
  function clearCreds() {
    sessionStorage.removeItem("u");
    sessionStorage.removeItem("p");
  }
  function basicAuthHeader(u, p) {
    return "Basic " + btoa(`${u}:${p}`);
  }

  function refreshLoginUI() {
    const {u, p} = getCreds();
    if (u && p) {
      loginStatus.textContent = `Logged in as ${u}`;
      logoutBtn.style.display = "";
    } else {
      loginStatus.textContent = "Not logged in.";
      logoutBtn.style.display = "none";
    }
  }

  async function doLogin() {
    const username = (uEl.value || "").trim().toLowerCase();
    const password = (pEl.value || "");

    if (!username || !password) {
      loginStatus.textContent = "Enter username + password.";
      return;
    }

    loginStatus.textContent = "Logging in‚Ä¶";

    const res = await fetch(AUTH_WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ username, password }),
    });

    let data = {};
    try { data = await res.json(); } catch {}

    if (!res.ok || !data.ok) {
      loginStatus.textContent = "Login failed.";
      return;
    }

    setCreds(username, password);
    refreshLoginUI();
  }

  loginBtn.addEventListener("click", doLogin);
  logoutBtn.addEventListener("click", () => {
    clearCreds();
    refreshLoginUI();
  });

  refreshLoginUI();

  // ===== PDF HELPERS =====
  function base64ToPdfBlob(base64) {
    const clean = String(base64).replace(/\s/g, '');
    const byteCharacters = atob(clean);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    return new Blob([new Uint8Array(byteNumbers)], { type: "application/pdf" });
  }

  function downloadPdfFromBase64(base64, filename) {
    const blob = base64ToPdfBlob(base64);
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename || "file.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  function viewPdfFromBase64(base64) {
    const blob = base64ToPdfBlob(base64);
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
    setTimeout(() => URL.revokeObjectURL(url), 60000);
  }

  function renderPdfsSafe(pdfs) {
    pdfsEl.innerHTML = "";

    if (!pdfs || pdfs.length === 0) {
      pdfsEl.className = "hint";
      pdfsEl.textContent = "No PDFs.";
      return;
    }

    pdfsEl.className = "";

    pdfs.forEach((p, idx) => {
      const row = document.createElement("div");
      row.className = "pdf-row";

      const left = document.createElement("div");
      const name = p.name || `PDF ${idx + 1}`;
      const mimetype = p.mimetype || "application/pdf";

      left.innerHTML = `
        <div class="pdf-name">${name}</div>
        <div class="pdf-meta">${mimetype}</div>
      `;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";

      const viewBtn = document.createElement("button");
      viewBtn.textContent = "View";
      viewBtn.className = "secondary";
      viewBtn.addEventListener("click", () => viewPdfFromBase64(p.data));

      const dlBtn = document.createElement("button");
      dlBtn.textContent = "Download";
      dlBtn.addEventListener("click", () => downloadPdfFromBase64(p.data, name));

      right.appendChild(viewBtn);
      right.appendChild(dlBtn);

      row.appendChild(left);
      row.appendChild(right);
      pdfsEl.appendChild(row);
    });
  }

  // ===== TASK FETCH =====
  async function fetchTask() {
    const id = String(taskIdInput.value || "").trim();
    if (!id) {
      statusEl.textContent = "Enter a task ID.";
      return;
    }

    const {u, p} = getCreds();
    if (!u || !p) {
      statusEl.textContent = "Please login first.";
      return;
    }

    const url = `${WEBHOOK_BASE}/task/${encodeURIComponent(id)}`;
    statusEl.textContent = `Fetching task ${id}‚Ä¶`;
    out.textContent = "‚Äî";
    renderPdfsSafe([]);

    try {
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          "Authorization": basicAuthHeader(u, p),
        },
        cache: "no-store",
      });

      const text = await res.text();
      let data = {};
      try { data = JSON.parse(text); } catch {}

      if (!res.ok) {
        statusEl.innerHTML = `<span class="error">HTTP ${res.status}</span>`;
        out.textContent = text;
        return;
      }

      const payload =
        Array.isArray(data) ? data[0] :
        (data && Array.isArray(data.data)) ? data.data[0] :
        data;

      statusEl.textContent = `Success ‚úÖ`;
      renderPdfsSafe(payload?.pdfs || []);
      out.textContent = JSON.stringify(payload, null, 2);

    } catch (err) {
      statusEl.innerHTML = `<span class="error">Network error</span>`;
      out.textContent = err.message;
    }
  }

  btn.addEventListener("click", fetchTask);
  taskIdInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") fetchTask();
  });
</script>
</body>
</html>
